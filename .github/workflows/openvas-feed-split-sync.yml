name: OpenVAS Feed Split Sync

on:
  schedule:
    - cron: "0 */2 * * *" # every 2 hours
  workflow_dispatch:

jobs:
  sync-feeds:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y rsync git-lfs
          git lfs install

      - name: Prepare workspace
        run: |
          mkdir -p feeds/nvt feeds/scap feeds/cert feeds/vt

      # === NVT FEED ===
      - name: Sync NVT Feed
        run: rsync -av --delete rsync://feed.community.greenbone.net:/nvt-feed/ feeds/nvt/

      - name: Split and push NVT Feed
        run: |
          # Create tar outside the source folder
          tar -cf nvt-feed.tar -C feeds nvt
          split -b 500m nvt-feed.tar nvt-part-
          i=1
          for part in nvt-part-*; do
            mkdir -p feeds/nvt-part-$i
            cat $part | tar -xf - -C feeds/nvt-part-$i
            cd feeds/nvt-part-$i
            git init
            git remote add origin https://x-access-token:${{ secrets.PAT_TOKEN }}@github.com/jbeasl7/openvas-nvt-feed-part-$i.git
            git checkout -B main
            git lfs track "*.nasl"
            git add .gitattributes
            git add .
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git commit -m "Update NVT feed part $i" || echo "No changes"
            git push origin main --force
            cd ../..
            i=$((i+1))
          done

      # === SCAP FEED ===
      - name: Sync SCAP Feed
        run: rsync -av --delete rsync://feed.community.greenbone.net/community/vulnerability-feed/24.10/scap-data/ feeds/scap/

      - name: Split and push SCAP Feed
        run: |
          tar -cf scap-feed.tar -C feeds scap
          split -b 500m scap-feed.tar scap-part-
          i=1
          for part in scap-part-*; do
            mkdir -p feeds/scap-part-$i
            cat $part | tar -xf - -C feeds/scap-part-$i
            cd feeds/scap-part-$i
            git init
            git remote add origin https://x-access-token:${{ secrets.PAT_TOKEN }}@github.com/jbeasl7/openvas-scap-feed-part-$i.git
            git checkout -B main
            git lfs track "*.json.gz" "*.json" "*.xml"
            git add .gitattributes
            git add .
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git commit -m "Update SCAP feed part $i" || echo "No changes"
            git push origin main --force
            cd ../..
            i=$((i+1))
          done

      # === CERT FEED ===
      - name: Sync CERT Feed
        run: rsync -av --delete rsync://feed.community.greenbone.net/community/vulnerability-feed/24.10/cert-data/ feeds/cert/

      - name: Push CERT Feed
        run: |
          cd feeds/cert
          git init
          git remote add origin https://x-access-token:${{ secrets.PAT_TOKEN }}@github.com/jbeasl7/openvas-cert-feed.git
          git checkout -B main
          git add .
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "Update CERT feed" || echo "No changes"
          git push origin main --force
          cd ../..

      # === VT FEED ===
      - name: Sync VT Feed
        run: rsync -av --delete rsync://feed.community.greenbone.net/community/vulnerability-feed/24.10/vt-data/ feeds/vt/

      - name: Split and push VT Feed
        run: |
          tar -cf vt-feed.tar -C feeds vt
          split -b 500m vt-feed.tar vt-part-
          i=1
          for part in vt-part-*; do
            mkdir -p feeds/vt-part-$i
            cat $part | tar -xf - -C feeds/vt-part-$i
            cd feeds/vt-part-$i
            git init
            git remote add origin https://x-access-token:${{ secrets.PAT_TOKEN }}@github.com/jbeasl7/openvas-vt-feed-part-$i.git
            git checkout -B main
            git lfs track "*.json.gz" "*.json"
            git add .gitattributes
            git add .
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git commit -m "Update VT feed part $i" || echo "No changes"
            git push origin main --force
            cd ../..
            i=$((i+1))
          done
